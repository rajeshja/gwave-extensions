<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
	<ModulePrefs title="Recommendations Gadget" height="250">
		<Require feature="wave" /> 
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
    <![CDATA[ 
		<style type="text/css">

			#reco-gadget {
				font-family: Verdana, Bitstream Vera Sans, sans-serif;
				font-size: 0.9em;
				max-height: 250px;
				overflow: scroll;
			}

			table.recos {
				margin: 0;
				padding: 0;
				border-collapse: collapse;
				font-family: Verdana, Bitstream Vera Sans, sans-serif;
				font-size: 0.9em;
			}
			
			.recos td, .recos th {
				border: solid black 1px;
				margin: 0;
				padding: 0;
			}

			.recos form {
				margin: 0;
				padding: 0;
			}

			.recos fieldset {
				border: 0;
				padding: 1px;
				margin: 0;
				font-size: 0.9em;
			}

			.recos fieldset input[type="radio"] {
				margin: 0;
				padding-left: 0px;
				height: 9px;
				width: 9px;
			}

			.recos fieldset input {
				font-size: 0.9em;
			}
		</style>
		<script type="text/javascript" 
						src="http://pune-gtug-wave-samples.googlecode.com/svn/trunk/wave-polling-gadget/json2.js"></script>
		<script type="text/javascript">

			function rate(radiobutton) {
				row = radiobutton.parentNode.parentNode.parentNode.parentNode;
				//row = document.getElementById("book" + rownum);
				bookcell = row.getElementsByTagName("TD")[1];
				ratingcell = row.getElementsByTagName("TD")[2];
				bookname = bookcell.textContent;
				ratingchoices = ratingcell.getElementsByTagName("FORM")[0].rating;
				ratingvalue = 0;
				if (ratingchoices.length < 1) return;
				for (i=0; i < ratingchoices.length; i++) {
					if (ratingchoices[i].checked) {
						ratingvalue = ratingchoices[i].value;
					}
				}
				ratingcell.innerHTML = (ratingvalue);
			}
			
			function addbookrow(bookname, rating) {
				newbookrow = document.getElementById("newbookentry");
				newcount=(newbookrow.parentNode.getElementsByTagName("TR").length - 2) + 1;

				newtr = document.getElementById("row-template").cloneNode(true);
				newtr.removeAttribute("style");
				
				//Set the Serial number
				srtd = newtr.getElementsByTagName("TD")[0];
				srtd.innerHTML = newcount;
				//Set the book name
				nametd = newtr.getElementsByTagName("TD")[1];
				nametd.innerHTML = bookname;
				//Set the tr identifier
				newtr.setAttribute("id", "book"+newcount);
				//If rating is there, set the cell to it.
				if (rating) {
					ratingtd = nametd = newtr.getElementsByTagName("TD")[2];
					ratingtd.innerHTML = rating;
				}

				newbookrow.parentNode.insertBefore(newtr, newbookrow);

				gadgets.window.adjustHeight(((150 + (newcount*28))> 250) ? 250 : (130 + (newcount*28)));

			}
			
			function addbookstate(bookname) {
				state = wave.getState();
				log("Original books element = " + state.get('books'));
				books = eval(state.get('books'));
				log("Books after eval = " + books);
				if (books) {
					log("book 0 = " + books[0]);
					if (books[0]) {
						log("book 0 is " + books[0].name + ":" + books[0].rating);
					}
				}

				if (!books) {
					books = new Array();
					books[0] = {"name":bookname, "rating":0};
				} else {
					//Should first check if the book already exists.
					var exists=false;
					for (i=0; i<books.length; i++) {
						if (books[i] == bookname) {
							exists=true;
						}
					}
					if (exists) {
						log("Duplicate addition!");
					} else {
						books[books.length] = {"name":bookname, "rating":0};
					}
				}
				
				booksstring = JSON.stringify(books);
				state.submitDelta({'books': booksstring});
				count = parseInt(state.get('count'));
				if (!count) {
					count = 0;
				}
				state.submitDelta({'count': count+1});
			}

			function addnewbook() {
				
				newbookrow = document.getElementById("newbookentry");
				newbookname = newbookrow.getElementsByTagName("FORM")[0].newbook.value;
				addbookrow(newbookname);
				log("Added Row");
				addbookstate(newbookname);
				log("Added State");
				wave.getState().submitDelta('newBookAdded', 1);
				log("Logged addition of State");

				return false;
			}

			function log(msg) {
				document.getElementById("messages").innerHTML += msg + "<br/>"; 
			}

			function disableEnterKey(e)
			{
				var key;     
				if(window.event)
					key = window.event.keyCode; //IE
				else
					key = e.which; //firefox     
				
				return (key != 13);
			}
			
			function tempClear() {
				wave.getState().submitDelta({'books': [] });
			}
			
			function init() {
				if (wave && wave.isInWaveContainer()) {
					wave.setStateCallback(stateUpdated);
				}
			}
			
			function stateUpdated() {
				if (parseInt(wave.getState().get('newBookAdded')) == 1) {
					log("A new book was added?");
				} else {
					log("State changed");
					showBookList();
				}
			}
			
			function showBookList() {
				state = wave.getState();
				if (!state) {
					log("No state available.");
				} else if (!state.get('books')) {
					log("No books available.");
				} else if (state.get('books').length && state.get('books').length > 0) {
					books = eval(state.get('books'));
					for (i=0; i<books.length; i++) {
						if (books[i].rating = 0) {
							addbookrow(books[i].name);
						} else {
							addbookrow(books[i].name, books[i].rating);
						}
					}
				}
				log("Count is " + state.get('count'));
			}
			
			gadgets.util.registerOnLoadHandler(init);

		</script>
		<div id="reco-gadget">
			<div id="messages"></div>
			<table class="recos">
				<thead>
					<tr>
						<th>Rank</th>
						<th>Book Name</th>
						<th>Rating (5=Love it, 1=Trash)</th>
					</tr>
				</thead>
				<tbody>
					<tr id="newbookentry">
						<td></td>
						<td>Book Name: 
						<form onkeypress="return disableEnterKey(event)">
							<fieldset>
								<input type="text" name="newbook"/>
								<input type="button" value="Add" onclick="addnewbook()"/>
								<input type="button" value="Clear books" onclick="tempClear()"/>
							</fieldset>
						</form>
						</td>
						<td>
						</td>
					</tr>
					<tr id="row-template" style="display: none;">
						<td>0</td>
						<td>Book 0</td>
						<td>
							<form action="rate.it">
								<fieldset class="rate-it">
									<input type="radio" name="rating" value="5" onchange="rate(this)" /> 5 
									<input type="radio" name="rating" value="4" onchange="rate(this)" /> 4 
									<input type="radio" name="rating" value="3" onchange="rate(this)" /> 3 
									<input type="radio" name="rating" value="2" onchange="rate(this)" /> 2 
									<input type="radio" name="rating" value="1" onchange="rate(this)" /> 1 
								</fieldset>
							</form>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
    ]]>
    </Content>
</Module>